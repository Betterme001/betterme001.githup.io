<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语法题目卡片测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            height: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: #4CAF50;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 40px;
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: transform 0.3s ease;
            position: relative;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        /* 4秒倒计时圆圈 */
        .timer {
            width: 48px;
            height: 48px;
            margin: 12px auto 0;
        }
        .timer svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .timer-circle-bg {
            fill: none;
            stroke: rgba(0,0,0,0.1);
            stroke-width: 6;
        }
        .timer-circle-progress {
            fill: none;
            stroke: #FFC107;
            stroke-width: 6;
            stroke-linecap: round;
            /* 2 * Math.PI * 17 ≈ 106.81 → 107 */
            stroke-dasharray: 107;
            stroke-dashoffset: 107;
        }
        .timer.animate .timer-circle-progress {
            animation: timerProgress 4s linear forwards;
        }
        @keyframes timerProgress {
            to { stroke-dashoffset: 0; }
        }

        .question {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .overall-progress {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 10px;
        }

        .review-count {
            font-size: 0.95rem;
            color: #888;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        .mastery-score {
            font-size: 0.9rem;
            color: #4CAF50;
            margin-top: 5px;
            font-weight: bold;
        }

        .answer-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .answer-section.show {
            display: block;
        }

        .translation {
            font-size: 1.4rem;
            color: #007bff;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .knowledge-point {
            font-size: 1.1rem;
            color: #666;
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: none;
            overflow: visible;
            text-align: left;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        /* 固定答案/计时器区域，避免高度抖动 */
        .answer-container {
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-mastered {
            background: #4CAF50;
            color: white;
        }

        .btn-mastered:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-unclear {
            background: #ff9800;
            color: white;
        }

        .btn-unclear:hover {
            background: #e68900;
            transform: translateY(-2px);
        }

        .btn-forgot {
            background: #f44336;
            color: white;
        }

        .btn-forgot:hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        .btn-next {
            background: #2196F3;
            color: white;
            display: none;
        }

        .btn-next:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn-next.show {
            display: inline-block;
        }

        .btn-mastered.hide,
        .btn-unclear.hide,
        .btn-forgot.hide {
            display: none;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            color: white;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .start-screen {
            text-align: center;
            color: white;
        }

        .start-btn {
            background: #4CAF50;
            color: white;
            padding: 20px 40px;
            font-size: 1.3rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            background: #45a049;
            transform: translateY(-3px);
        }

        .management-screen {
            text-align: center;
            color: white;
            display: none;
        }

        .management-screen.show {
            display: block;
        }

        .management-title {
            font-size: 2.5rem;
            margin-bottom: 30px;
        }

        .management-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 400px;
            margin: 0 auto;
        }

        .mgmt-btn {
            background: #2196F3;
            color: white;
            padding: 20px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 60px;
        }

        .mgmt-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .mgmt-btn.review {
            background: #FF9800;
        }

        .mgmt-btn.review:hover {
            background: #F57C00;
        }

        .mgmt-btn.test {
            background: #4CAF50;
        }

        .mgmt-btn.test:hover {
            background: #45a049;
        }

        .mgmt-btn.library {
            background: #9C27B0;
        }

        .mgmt-btn.library:hover {
            background: #7B1FA2;
        }

        .progress-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .progress-item {
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .library-screen {
            display: none;
            text-align: left;
            color: white;
        }

        .library-screen.show {
            display: block;
        }

        .library-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .library-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .library-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .library-question {
            font-size: 1.1rem;
            flex: 1;
            margin-right: 15px;
        }

        .library-translation {
            color: #4CAF50;
            font-weight: bold;
        }

        .back-btn {
            background: #f44336;
            color: white;
            padding: 10px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        /* 简洁的返回箭头按钮 */
        .icon-back {
            background: rgba(255,255,255,0.9);
            color: #333;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 8px 0;
        }
        .icon-back:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        .completion-screen {
            text-align: center;
            color: white;
            display: none;
        }

        .completion-screen.show {
            display: block;
        }

        .completion-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .completion-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .restart-btn {
            background: #2196F3;
            color: white;
            padding: 15px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        @media (max-width: 600px) {
            .card {
                padding: 20px;
                min-height: 300px;
            }
            
            .question {
                font-size: 1.4rem;
            }
            
            .buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>语法题目卡片测试</h1>
            <p>每天20分钟，坚持3年，成就非凡人生</p>
        </div>

        <!-- 管理界面 -->
        <div class="management-screen" id="managementScreen">
            <div class="progress-info" id="progressInfo">
                <div class="progress-item">测试进度：<span id="testProgress">0</span> / <span id="totalQuestions">0</span></div>
                <div class="progress-item">复习进度：<span id="reviewProgress">0</span> / <span id="totalQuestions2">0</span></div>
                <div class="progress-item">掌握程度：<span id="reviewedCount">0/0</span></div>
            </div>
            <div class="management-buttons">
                <button class="mgmt-btn review" onclick="startReview()">开始复习</button>
                <button class="mgmt-btn test" onclick="startTest()">开始测试</button>
                <button class="mgmt-btn library" onclick="showQuestionBank()">展示题库</button>
            </div>
        </div>

        <!-- 开始屏幕 -->
        <div class="start-screen" id="startScreen" style="display: none;">
            <h2>准备开始测试</h2>
            <p>每次测试包含10个题目</p>
            <p>根据你的掌握程度选择：掌握、模糊、忘记</p>
            <button class="start-btn" onclick="startTest()">开始测试</button>
        </div>

        <!-- 测试屏幕 -->
        <div id="testScreen" style="display: none;">
            <div style="display: flex; justify-content: flex-start; margin-bottom: 10px;">
                <button class="icon-back" aria-label="返回" onclick="backToManagement()">←</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">题目 1 / 20</div>
            
            <div class="card">
                <div class="overall-progress" id="overallProgressTop"></div>
                <div class="question" id="questionText"></div>
                <div class="review-count" id="reviewCountText"></div>
                <div class="mastery-score" id="masteryScoreText"></div>
                
                <div class="answer-container">
                <div class="answer-section" id="answerSection">
                    <div class="translation" id="translationText"></div>
                    <div class="knowledge-point" id="knowledgePointText"></div>
                    </div>
                    <div class="timer" id="timer">
                        <svg viewBox="0 0 40 40">
                            <!-- 使用 r=17, stroke-width=6，避免被裁剪 -->
                            <circle class="timer-circle-bg" cx="20" cy="20" r="17"></circle>
                            <circle class="timer-circle-progress" cx="20" cy="20" r="17"></circle>
                        </svg>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-mastered" id="masteredBtn" onclick="selectAnswer('mastered')">掌握</button>
                    <button class="btn btn-unclear" id="unclearBtn" onclick="selectAnswer('unclear')">模糊</button>
                    <button class="btn btn-forgot" id="forgotBtn" onclick="selectAnswer('forgot')">忘记</button>
                    <button class="btn btn-next" id="nextBtn" onclick="nextQuestion()">下一题</button>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="masteredCount">0</div>
                    <div class="stat-label">掌握</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="unclearCount">0</div>
                    <div class="stat-label">模糊</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="forgotCount">0</div>
                    <div class="stat-label">忘记</div>
                </div>
            </div>
        </div>

        <!-- 完成屏幕 -->
        <div class="completion-screen" id="completionScreen">
            <div class="completion-title">测试完成！</div>
            <div class="completion-stats">
                <h3>本次测试结果</h3>
                <p>掌握：<span id="finalMastered">0</span> 题</p>
                <p>模糊：<span id="finalUnclear">0</span> 题</p>
                <p>忘记：<span id="finalForgot">0</span> 题</p>
                <p>总题数：10 题</p>
            </div>
            <button class="restart-btn" onclick="backToManagement()">返回管理界面</button>
        </div>

        <!-- 题库展示屏幕 -->
        <div class="library-screen" id="libraryScreen">
            <div class="library-header">
                <h2>题库列表</h2>
                <button class="back-btn" onclick="backToManagement()">返回管理界面</button>
            </div>
            <div class="library-list" id="libraryList">
                <!-- 题库内容将在这里动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 题目数据
        const SESSION_SIZE = 10; // 每次测试题量
        let questions = [];
        let currentQuestionIndex = 0;
        let testQuestions = [];
        let stats = {
            mastered: 0,
            unclear: 0,
            forgot: 0
        };
        
        // 复习模式
        let isReviewMode = false; // 是否为复习模式（掌握度最低的题目）
        let reviewQuestions = []; // 复习题目列表
        
        // 复习进度管理
        let reviewProgress = 0; // 复习进度（已复习到的题目索引）
        let isReviewSession = false; // 是否为复习会话

        // 本地持久化（localStorage）
        const STORAGE_KEY = 'grammar_review_v1';
        let reviewStore = { // { [questionKey]: { status, count, lastReviewed, unclearCount, forgotCount, masteredCount } }
            items: {},
            meta: {
                globalProgressIndex: 0,     // 全局进展（下一题索引，0-based）
                lastSessionDate: '',        // 上一次"每日首次启动"的日期
                reviewProgress: 0           // 复习进度
            }
        };

        function loadStore() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    reviewStore = JSON.parse(raw);
                }
            } catch (e) {
                console.warn('读取本地数据失败:', e);
            }
        }

        function saveStore() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(reviewStore));
            } catch (e) {
                console.warn('保存本地数据失败:', e);
            }
        }

        function getQuestionKey(q) {
            return q.question; // 以题目文本作为键
        }

        // 加载题目数据
        async function loadQuestions() {
            try {
                const response = await fetch('questions_data.json');
                questions = await response.json();
                console.log(`加载了 ${questions.length} 个题目`);
                loadStore();
            } catch (error) {
                console.error('加载题目数据失败:', error);
                // 如果无法加载JSON文件，使用示例数据
                questions = [
                    {
                        question: "一个感到无聊的人",
                        translation: "a bored man",
                        knowledge_point: "形容词"
                    },
                    {
                        question: "令人厌烦的人",
                        translation: "a boring man",
                        knowledge_point: "形容词"
                    },
                    {
                        question: "她没有被逗笑",
                        translation: "She was not amused",
                        knowledge_point: "形容词"
                    }
                ];
            }
        }

        // 开始测试
        function startTest() {
            // 检查是否需要先进行复习模式
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            const meta = reviewStore.meta || { globalProgressIndex: 0, lastSessionDate: '' };
            
            if (meta.lastSessionDate !== todayStr) {
                // 每天第一次：先进行复习模式
                startReviewMode();
            } else {
                // 当天后续：直接开始正式测试
                startNormalTest();
            }
        }
        
        // 开始复习模式（掌握度最低的题目）
        function startReviewMode() {
            isReviewMode = true;
            reviewQuestions = getLowestMasteryQuestions();
            testQuestions = reviewQuestions;
            currentQuestionIndex = 0;
            stats = { mastered: 0, unclear: 0, forgot: 0 };
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'block';
            document.getElementById('completionScreen').classList.remove('show');
            
            // 更新标题显示复习模式
            document.getElementById('progressText').textContent = `复习模式 ${currentQuestionIndex + 1} / ${testQuestions.length}`;
            
            showQuestion();
            updateStats();
        }

        // 开始正式测试
        function startNormalTest() {
            isReviewMode = false;
            // 顺序选择题目
            const startIndex = determineSessionStartIndex();
            testQuestions = buildSequentialQuestions(startIndex, SESSION_SIZE);
            // 记录本次会话将推进的进度终点（完成后写回）
            reviewStore.meta.pendingProgressIndex = (startIndex + testQuestions.length) % questions.length;
            saveStore();
            currentQuestionIndex = 0;
            stats = { mastered: 0, unclear: 0, forgot: 0 };
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'block';
            document.getElementById('completionScreen').classList.remove('show');
            
            showQuestion();
            updateStats();
        }

        // 获取掌握度≤90%的题目
        function getLowestMasteryQuestions() {
            const currentProgress = reviewStore.meta.globalProgressIndex || 0;
            const previousQuestions = [];
            
            // 获取当前进度之前的所有题目
            for (let i = 0; i < currentProgress; i++) {
                previousQuestions.push(questions[i]);
            }
            
            // 如果之前的题目不足，从所有题目中选择
            const sourceQuestions = previousQuestions.length > 0 ? previousQuestions : questions;
            
            // 计算每题的掌握度并过滤掉掌握度>90%的题目
            const questionsWithMastery = sourceQuestions.map(q => {
                const key = getQuestionKey(q);
                const entry = reviewStore.items[key] || {};
                const m = entry.masteredCount || 0;
                const u = entry.unclearCount || 0;
                const f = entry.forgotCount || 0;
                const mastery = calculateMastery(m, u, f);
                return { question: q, mastery: mastery };
            }).filter(item => item.mastery <= 90); // 过滤掉掌握度>90%的题目
            
            // 按掌握度升序排序，返回所有掌握度≤90%的题目
            questionsWithMastery.sort((a, b) => a.mastery - b.mastery);
            return questionsWithMastery.map(item => item.question);
        }

        // 构建顺序题目列表（循环到头从头开始）
        function buildSequentialQuestions(startIndex, count) {
            const result = [];
            for (let i = 0; i < count; i++) {
                const idx = (startIndex + i) % questions.length;
                result.push(questions[idx]);
            }
            return result;
        }

        // 计算本次会话的开始索引
        function determineSessionStartIndex() {
            const total = questions.length;
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            const meta = reviewStore.meta || { globalProgressIndex: 0, lastSessionDate: '' };
            let startIndex;
            if (meta.lastSessionDate !== todayStr) {
                // 每天第一次：从当前进展-20开始（不足则从第1个）
                startIndex = meta.globalProgressIndex >= 20 ? meta.globalProgressIndex - 20 : 0;
                meta.lastSessionDate = todayStr;
            } else {
                // 当天后续会话：从当前进展开始
                startIndex = meta.globalProgressIndex % total;
            }
            reviewStore.meta = meta;
            saveStore();
            return startIndex;
        }

        // 显示当前题目
        function showQuestion() {
            const question = testQuestions[currentQuestionIndex];
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('translationText').textContent = question.translation;
            document.getElementById('knowledgePointText').textContent = question.knowledge_point;
            // 显示整体进度：当前题在题库中的序号/总数
            const total = questions.length;
            // 计算当前题在题库中的绝对序号
            const startIndexGuess = (reviewStore.meta.pendingProgressIndex - testQuestions.length + total) % total; // 会话起点
            const absoluteIndex = (startIndexGuess + currentQuestionIndex) % total; // 0-based
            document.getElementById('overallProgressTop').textContent = `${absoluteIndex + 1} / ${total}`;
            // 显示该题复习次数
            const key = getQuestionKey(question);
            const entry = reviewStore.items[key] || {};
            const count = entry.count || 0;
            const m = entry.masteredCount || 0;
            const u = entry.unclearCount || 0;
            const f = entry.forgotCount || 0;
            
            // 计算并显示掌握度
            const mastery = calculateMastery(m, u, f);
            document.getElementById('masteryScoreText').textContent = `掌握度：${mastery}%`;
            
            // 隐藏答案区域，显示所有按钮
            document.getElementById('answerSection').classList.remove('show');
            document.getElementById('nextBtn').classList.remove('show');
            document.getElementById('masteredBtn').classList.remove('hide');
            document.getElementById('unclearBtn').classList.remove('hide');
            document.getElementById('forgotBtn').classList.remove('hide');
            
            // 更新进度
            updateProgress();

            // 预先测量答案高度并占位，避免切换时抖动
            reserveAnswerSpace();

            // 启动4秒倒计时，结束显示答案
            startTimer();
        }

        function reserveAnswerSpace() {
            const container = document.querySelector('.answer-container');
            const section = document.getElementById('answerSection');
            if (!container || !section) return;
            // 重置高度
            container.style.height = '';
            // 临时显示以测量真实高度
            const prevDisplay = section.style.display;
            const prevVisibility = section.style.visibility;
            section.style.display = 'block';
            section.style.visibility = 'hidden';
            const height = section.offsetHeight;
            // 还原
            section.style.display = '';
            section.style.visibility = '';
            // 设定固定高度，至少120px，但允许内容超出
            const reserved = Math.max(120, height);
            container.style.height = reserved + 'px';
            container.style.overflow = 'visible';
        }

        // 选择答案
        function selectAnswer(type) {
            stats[type]++;
            updateStats();
            stopTimer();
            
            if (type === 'mastered') {
                // 掌握直接进入下一题
                persistCurrentAnswer(type);
                nextQuestion();
            } else {
                // 模糊或忘记显示答案，隐藏其他按钮
                document.getElementById('answerSection').classList.add('show');
                document.getElementById('nextBtn').classList.add('show');
                document.getElementById('masteredBtn').classList.add('hide');
                document.getElementById('unclearBtn').classList.add('hide');
                document.getElementById('forgotBtn').classList.add('hide');
                // 隐藏计时器
                const timer = document.getElementById('timer');
                if (timer) timer.style.display = 'none';
                // 立即记录结果
                persistCurrentAnswer(type);
            }
        }

        let timerHandle = null;
        function startTimer() {
            stopTimer();
            const timer = document.getElementById('timer');
            if (!timer) return;
            // 重置动画
            timer.classList.remove('animate');
            // 强制回流以重启动画
            void timer.offsetWidth;
            // 显示计时器并开始动画
            timer.style.display = 'block';
            timer.classList.add('animate');
            // 4秒后显示答案
            timerHandle = setTimeout(() => {
                document.getElementById('answerSection').classList.add('show');
                // 到时隐藏计时器
                const t = document.getElementById('timer');
                if (t) t.style.display = 'none';
            }, 4000);
        }
        function stopTimer() {
            const timer = document.getElementById('timer');
            if (timer) timer.classList.remove('animate');
            if (timerHandle) {
                clearTimeout(timerHandle);
                timerHandle = null;
            }
        }

        function persistCurrentAnswer(type) {
            const q = testQuestions[currentQuestionIndex];
            if (!q) return;
            const key = getQuestionKey(q);
            const entry = reviewStore.items[key] || { status: '', count: 0, lastReviewed: 0, unclearCount: 0, forgotCount: 0, masteredCount: 0 };
            entry.status = type; // 最后一次结果：mastered/unclear/forgot
            entry.count = (entry.count || 0) + 1;
            entry.lastReviewed = Date.now();
            if (type === 'unclear') {
                entry.unclearCount = (entry.unclearCount || 0) + 1;
            } else if (type === 'forgot') {
                entry.forgotCount = (entry.forgotCount || 0) + 1;
            } else if (type === 'mastered') {
                entry.masteredCount = (entry.masteredCount || 0) + 1;
            }
            reviewStore.items[key] = entry;
            saveStore();
        }

        // 下一题
        function nextQuestion() {
            // 防止残留计时器
            stopTimer();
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= testQuestions.length) {
                // 测试完成
                if (isReviewSession) {
                    // 复习会话完成，更新复习进度
                    updateReviewProgress();
                    showManagementScreen();
                } else if (isReviewMode) {
                    // 复习模式完成，开始正式测试
                    startNormalTest();
                } else {
                    // 正式测试完成，推进全局进度
                    const total = questions.length;
                    const nextIndex = (reviewStore.meta.pendingProgressIndex || 0) % total;
                    reviewStore.meta.globalProgressIndex = nextIndex;
                    saveStore();
                showCompletion();
                }
            } else {
                showQuestion();
            }
        }

        // 更新复习进度
        function updateReviewProgress() {
            if (isReviewSession && testQuestions.length > 0) {
                // 找到第一个被选中复习的题目在题库中的索引
                const firstQuestion = testQuestions[0];
                const firstIndex = questions.findIndex(q => q.question === firstQuestion.question);
                
                if (firstIndex !== -1) {
                    // 复习进度更新为第一个复习题目的索引减1
                    reviewStore.meta.reviewProgress = firstIndex - 1;
                    
                    // 如果复习进度小于0，重置为0
                    if (reviewStore.meta.reviewProgress < 0) {
                        reviewStore.meta.reviewProgress = 0;
                    }
                    
                    // 如果复习进度达到测试进度，重置复习进度
                    if (reviewStore.meta.reviewProgress >= reviewStore.meta.globalProgressIndex) {
                        reviewStore.meta.reviewProgress = 0;
                    }
                    
                    saveStore();
                }
            }
        }

        // 显示完成屏幕
        function showCompletion() {
            document.getElementById('testScreen').style.display = 'none';
            document.getElementById('completionScreen').classList.add('show');
            
            document.getElementById('finalMastered').textContent = stats.mastered;
            document.getElementById('finalUnclear').textContent = stats.unclear;
            document.getElementById('finalForgot').textContent = stats.forgot;
        }

        // 重新开始测试
        function restartTest() {
            document.getElementById('completionScreen').classList.remove('show');
            document.getElementById('startScreen').style.display = 'block';
        }

        // 计算掌握度（建议2：简化权重）
        function calculateMastery(mastered, unclear, forgot) {
            const total = mastered + unclear + forgot;
            if (total === 0) return 0;
            
            const raw = (mastered - forgot) / total; // [-1, 1]
            const score = (raw + 1) / 2; // 映射到 [0, 1]
            return Math.round(score * 100); // 0-100%
        }

        // 可选：清除本地记录（在控制台调用 clearProgress() 即可）
        function clearProgress() {
            localStorage.removeItem(STORAGE_KEY);
            reviewStore = { items: {} };
            console.log('已清除本地复习记录');
        }

        // 更新进度
        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / testQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            if (isReviewMode) {
                document.getElementById('progressText').textContent = `复习模式 ${currentQuestionIndex + 1} / ${testQuestions.length}`;
            } else {
            document.getElementById('progressText').textContent = `题目 ${currentQuestionIndex + 1} / ${testQuestions.length}`;
            }
        }

        // 更新统计
        function updateStats() {
            document.getElementById('masteredCount').textContent = stats.mastered;
            document.getElementById('unclearCount').textContent = stats.unclear;
            document.getElementById('forgotCount').textContent = stats.forgot;
        }

        // 显示管理界面
        function showManagementScreen() {
            document.getElementById('managementScreen').style.display = 'block';
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'none';
            document.getElementById('completionScreen').classList.remove('show');
            document.getElementById('libraryScreen').classList.remove('show');
            
            updateProgressDisplay();
        }

        // 更新进度显示
        function updateProgressDisplay() {
            const testProgress = reviewStore.meta.globalProgressIndex || 0; // 当前进度
            const reviewProgress = reviewStore.meta.reviewProgress || 0;     // 复习进度指针
            const totalQuestions = questions.length;

            // 测试进度：当前进度 / 题目总数
            document.getElementById('testProgress').textContent = testProgress;
            document.getElementById('totalQuestions').textContent = totalQuestions;

            // 复习进度：（当前进度 - 复习进度）/ 当前进度（避免 0 除）
            const denom = Math.max(0, testProgress);
            const numer = denom > 0 ? Math.max(0, testProgress - reviewProgress) : 0;
            document.getElementById('reviewProgress').textContent = numer;
            document.getElementById('totalQuestions2').textContent = denom;

            // 掌握程度：分子/分母，其中 分母=testProgress，
            // 分子=遍历 testProgress 之前的题目中，掌握度>80% 的个数
            let masteredHighCount = 0;
            const limit = Math.min(testProgress, questions.length);
            if (limit > 0 && reviewStore.items) {
                for (let i = 0; i < limit; i++) {
                    const q = questions[i];
                    const key = getQuestionKey(q);
                    const entry = reviewStore.items[key];
                    if (entry && (entry.masteredCount || entry.unclearCount || entry.forgotCount)) {
                        const m = entry.masteredCount || 0;
                        const u = entry.unclearCount || 0;
                        const f = entry.forgotCount || 0;
                        const mastery = calculateMastery(m, u, f);
                        if (mastery > 80) masteredHighCount++;
                    }
                }
            }
            document.getElementById('reviewedCount').textContent = `${masteredHighCount}/${testProgress}`;
        }

        // 开始复习
        function startReview() {
            // 如果复习进度为0，设置为当前测试进度
            if (reviewStore.meta.reviewProgress === 0) {
                reviewStore.meta.reviewProgress = reviewStore.meta.globalProgressIndex || 0;
                saveStore();
            }
            
            isReviewSession = true;
            isReviewMode = true;
            
            // 从当前复习进度往前20个题目中选择10个掌握度最低的
            const startIndex = Math.max(0, reviewStore.meta.reviewProgress - 20);
            const endIndex = reviewStore.meta.reviewProgress;
            const candidateQuestions = questions.slice(startIndex, endIndex);
            
            // 检查是否有足够的题目可以复习
            if (candidateQuestions.length === 0) {
                // 重新设置复习进度为当前测试进度，开始新一轮复习
                reviewStore.meta.reviewProgress = reviewStore.meta.globalProgressIndex || 0;
                saveStore();
                
                // 重新计算复习范围
                const newStartIndex = Math.max(0, reviewStore.meta.reviewProgress - 20);
                const newEndIndex = reviewStore.meta.reviewProgress;
                const newCandidateQuestions = questions.slice(newStartIndex, newEndIndex);
                
                reviewQuestions = getLowestMasteryQuestionsFromCandidates(newCandidateQuestions);
            } else {
                reviewQuestions = getLowestMasteryQuestionsFromCandidates(candidateQuestions);
            }
            
            testQuestions = reviewQuestions;
            currentQuestionIndex = 0;
            stats = { mastered: 0, unclear: 0, forgot: 0 };
            
            document.getElementById('managementScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'block';
            document.getElementById('completionScreen').classList.remove('show');
            
            // 更新标题显示复习模式
            document.getElementById('progressText').textContent = `复习模式 ${currentQuestionIndex + 1} / ${testQuestions.length}`;
            
            showQuestion();
            updateStats();
        }

        // 从候选题目中获取掌握度≤90%的题目
        function getLowestMasteryQuestionsFromCandidates(candidates) {
            // 计算每题的掌握度并过滤掉掌握度>90%的题目
            const questionsWithMastery = candidates.map(q => {
                const key = getQuestionKey(q);
                const entry = reviewStore.items[key] || {};
                const m = entry.masteredCount || 0;
                const u = entry.unclearCount || 0;
                const f = entry.forgotCount || 0;
                const mastery = calculateMastery(m, u, f);
                return { question: q, mastery: mastery };
            }).filter(item => item.mastery <= 90); // 过滤掉掌握度>90%的题目
            
            // 按掌握度升序排序，返回所有掌握度≤90%的题目
            questionsWithMastery.sort((a, b) => a.mastery - b.mastery);
            return questionsWithMastery.map(item => item.question);
        }

        // 开始测试
        function startTest() {
            isReviewSession = false;
            isReviewMode = false;
            
            // 顺序选择题目
            const startIndex = determineSessionStartIndex();
            testQuestions = buildSequentialQuestions(startIndex, SESSION_SIZE);
            // 记录本次会话将推进的进度终点（完成后写回）
            reviewStore.meta.pendingProgressIndex = (startIndex + testQuestions.length) % questions.length;
            saveStore();
            currentQuestionIndex = 0;
            stats = { mastered: 0, unclear: 0, forgot: 0 };
            
            document.getElementById('managementScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'block';
            document.getElementById('completionScreen').classList.remove('show');
            
            showQuestion();
            updateStats();
        }

        // 展示题库
        function showQuestionBank() {
            document.getElementById('managementScreen').style.display = 'none';
            document.getElementById('libraryScreen').classList.add('show');
            
            const libraryList = document.getElementById('libraryList');
            libraryList.innerHTML = '';
            
            questions.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = 'library-item';
                
                const key = getQuestionKey(q);
                const entry = reviewStore.items[key] || {};
                const m = entry.masteredCount || 0;
                const u = entry.unclearCount || 0;
                const f = entry.forgotCount || 0;
                const mastery = calculateMastery(m, u, f);
                
                item.innerHTML = `
                    <div class="library-question">
                        <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 8px;">${index + 1}. ${q.question}</div>
                        <div style="font-size: 1.1rem; color: #4CAF50; margin-bottom: 8px;">${q.translation}</div>
                        <div style="font-size: 1rem; color: #666;">${q.knowledge_point}</div>
                    </div>
                    <div class="library-stats">
                        掌握度: ${mastery}% | 掌握: ${m} | 模糊: ${u} | 忘记: ${f}
                    </div>
                `;
                
                libraryList.appendChild(item);
            });
        }

        // 返回管理界面
        function backToManagement() {
            showManagementScreen();
        }

        // 页面加载完成后初始化
        window.addEventListener('load', async function() {
            // 先加载本地存储，再等待题目加载完成，最后再展示管理界面
            loadStore();
            await loadQuestions();
            showManagementScreen();
        });
    </script>
</body>
</html>
